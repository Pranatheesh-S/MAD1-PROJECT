{% extends 'layout.html' %}

{% block styles %}
<style>
    .slot-grid {
        display: grid;
        /* Define 3 columns: Date, Slot 1, Slot 2 */
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        align-items: center;
    }
    .slot-date {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        text-align: center;
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .slot-time {
        padding: 10px;
        border: 2px solid;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
    }
    /* Green slot: Available AND Doctor is working */
    .slot-available {
        border-color: #198754; /* Green */
        color: #198754;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    .slot-available:hover {
        background-color: #f0fff8;
    }
    /* Red slot: Booked OR Doctor not working */
    .slot-unavailable {
        border-color: #dc3545; /* Red */
        color: #dc3545;
        background-color: #fdf2f3;
        text-decoration: line-through;
        opacity: 0.6;
        cursor: not-allowed;
    }
    /* Blue selected slot */
    .slot-selected {
        border-color: #0d6efd; /* Blue */
        background-color: #e7f0ff;
        box-shadow: 0 0 8px rgba(13,110,253,0.5);
        transform: scale(1.02);
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Doctor's Availability</h3>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">Go Back</a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h4 class="card-title">Book with {{ doctor.name }}</h4>
        <h6 class="card-subtitle mb-4 text-muted">{{ doctor.specialization }}</h6>
        
        <form method="POST" action="{{ url_for('book_appointment', doctor_id=doctor.id) }}" id="booking-form">
            
            <input type="hidden" id="selected_slot_input" name="selected_slot" value="" required>

            <div class="slot-grid">
                <div class="text-center fw-bold">Date</div>
                <div class="text-center fw-bold">Morning (08:00 AM)</div>
                <div class="text-center fw-bold">Evening (04:00 PM)</div>

                {% for day_data in availability_data %}
                    
                    <div class="slot-date">
                        {{ day_data.date.strftime('%d/%m/%Y') }}<br>
                        <small class="text-muted">{{ day_data.date.strftime('%A') }}</small>
                    </div>
                    
                    {% for slot in day_data.slots %}
                        {% if slot.is_available %}
                            <div class="slot-time slot-available" 
                                 data-value="{{ day_data.date.isoformat() }}_{{ slot.time.isoformat() }}">
                                {{ slot.time.strftime('%I:%M %p') }}
                            </div>
                        {% else %}
                            <div class="slot-time slot-unavailable" title="Unavailable or Booked">
                                {{ slot.time.strftime('%I:%M %p') }}
                            </div>
                        {% endif %}
                    {% endfor %}

                {% endfor %}
            </div>

            <hr>
            <div class="d-flex align-items-center">
                <button type="submit" id="book-button" class="btn btn-success" disabled>Book Selected Slot</button>
                <small id="book-help" class="form-text text-muted ms-2">Please select a green slot to book.</small>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const hiddenInput = document.getElementById('selected_slot_input');
        const bookButton = document.getElementById('book-button');
        const bookHelp = document.getElementById('book-help');
        const availableSlots = document.querySelectorAll('.slot-available');
        
        availableSlots.forEach(function(slot) {
            slot.addEventListener('click', function() {
                // 1. Remove 'selected' from others
                availableSlots.forEach(s => s.classList.remove('slot-selected'));
                
                // 2. Add 'selected' to clicked
                this.classList.add('slot-selected');
                
                // 3. Update hidden input
                hiddenInput.value = this.getAttribute('data-value');
                
                // 4. Enable button
                bookButton.disabled = false;
                bookHelp.style.display = 'none';
            });
        });
    });
</script>
{% endblock %}